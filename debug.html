<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNKI Helper è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        
        .debug-section h3 {
            color: #555;
            margin-top: 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .debug-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .debug-button:hover {
            background: #0056b3;
        }
        
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ FK_CNKI è°ƒè¯•é¡µé¢</h1>
        
        <div class="debug-section">
            <h3>ğŸ“‹ æ‰©å±•çŠ¶æ€æ£€æŸ¥</h3>
            <button class="debug-button" onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
            <button class="debug-button" onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
            <button class="debug-button" onclick="testStorage()">æµ‹è¯•å­˜å‚¨</button>
            <button class="debug-button" onclick="testMessaging()">æµ‹è¯•æ¶ˆæ¯ä¼ é€’</button>
            <div id="extensionStatus" class="debug-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</div>
        </div>

        <div class="debug-section">
            <h3>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h3>
            <button class="debug-button" onclick="testCopyRestrictions()">æµ‹è¯•å¤åˆ¶é™åˆ¶è§£é™¤</button>
            <button class="debug-button" onclick="testUIInjection()">æµ‹è¯•UIæ³¨å…¥</button>
            <button class="debug-button" onclick="testSettings()">æµ‹è¯•è®¾ç½®åŠŸèƒ½</button>
            <div id="functionTest" class="debug-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="debug-section">
            <h3>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h3>
            <button class="debug-button" onclick="showSystemInfo()">æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯</button>
            <button class="debug-button" onclick="showConsoleLogs()">æ˜¾ç¤ºæ§åˆ¶å°æ—¥å¿—</button>
            <div id="systemInfo" class="debug-output">ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºä¿¡æ¯...</div>
        </div>

        <div class="debug-section">
            <h3>ğŸ” é”™è¯¯è¯Šæ–­</h3>
            <button class="debug-button" onclick="diagnoseErrors()">è¯Šæ–­é”™è¯¯</button>
            <button class="debug-button" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <div id="errorDiagnosis" class="debug-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹è¯Šæ–­...</div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥æ‰©å±•çŠ¶æ€
        async function checkExtensionStatus() {
            const output = document.getElementById('extensionStatus');
            output.textContent = 'æ­£åœ¨æ£€æŸ¥æ‰©å±•çŠ¶æ€...\n';
            
            try {
                // æ£€æŸ¥æ‰©å±•æ˜¯å¦å·²å®‰è£…
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    output.textContent += 'âœ… Chromeæ‰©å±•APIå¯ç”¨\n';
                    
                    // æ£€æŸ¥æ‰©å±•ID
                    if (chrome.runtime.id) {
                        output.textContent += `âœ… æ‰©å±•ID: ${chrome.runtime.id}\n`;
                    } else {
                        output.textContent += 'âŒ æ— æ³•è·å–æ‰©å±•ID\n';
                    }
                    
                    // æ£€æŸ¥æ‰©å±•URL
                    const extensionURL = chrome.runtime.getURL('');
                    output.textContent += `âœ… æ‰©å±•URL: ${extensionURL}\n`;
                    
                } else {
                    output.textContent += 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨\n';
                }
                
                // æ£€æŸ¥CNKI Helperç‰¹å®šå…ƒç´ 
                const toolbar = document.getElementById('cnki-helper-toolbar');
                const copyFixStyle = document.getElementById('cnki-helper-copy-fix');
                
                if (toolbar) {
                    output.textContent += 'âœ… FK_CNKIå·¥å…·æ å·²æ³¨å…¥\n';
                } else {
                    output.textContent += 'âŒ FK_CNKIå·¥å…·æ æœªæ³¨å…¥\n';
                }
                
                if (copyFixStyle) {
                    output.textContent += 'âœ… å¤åˆ¶é™åˆ¶è§£é™¤æ ·å¼å·²æ³¨å…¥\n';
                } else {
                    output.textContent += 'âŒ å¤åˆ¶é™åˆ¶è§£é™¤æ ·å¼æœªæ³¨å…¥\n';
                }
                
            } catch (error) {
                output.textContent += `âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}\n`;
            }
        }

        // æ£€æŸ¥æƒé™
        async function checkPermissions() {
            const output = document.getElementById('extensionStatus');
            output.textContent = 'æ­£åœ¨æ£€æŸ¥æƒé™...\n';
            
            try {
                // æ£€æŸ¥å­˜å‚¨æƒé™
                try {
                    await chrome.storage.sync.get('test');
                    output.textContent += 'âœ… å­˜å‚¨æƒé™æ­£å¸¸\n';
                } catch (error) {
                    output.textContent += `âŒ å­˜å‚¨æƒé™å¼‚å¸¸: ${error.message}\n`;
                }
                
                // æ£€æŸ¥æ ‡ç­¾é¡µæƒé™
                try {
                    await chrome.tabs.query({ active: true, currentWindow: true });
                    output.textContent += 'âœ… æ ‡ç­¾é¡µæƒé™æ­£å¸¸\n';
                } catch (error) {
                    output.textContent += `âŒ æ ‡ç­¾é¡µæƒé™å¼‚å¸¸: ${error.message}\n`;
                }
                
                // æ£€æŸ¥è„šæœ¬æ³¨å…¥æƒé™
                try {
                    await chrome.scripting.executeScript({
                        target: { tabId: chrome.tabs.TAB_ID_NONE },
                        func: () => 'test'
                    });
                    output.textContent += 'âœ… è„šæœ¬æ³¨å…¥æƒé™æ­£å¸¸\n';
                } catch (error) {
                    output.textContent += `âŒ è„šæœ¬æ³¨å…¥æƒé™å¼‚å¸¸: ${error.message}\n`;
                }
                
            } catch (error) {
                output.textContent += `âŒ æƒé™æ£€æŸ¥è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}\n`;
            }
        }

        // æµ‹è¯•å­˜å‚¨
        async function testStorage() {
            const output = document.getElementById('extensionStatus');
            output.textContent = 'æ­£åœ¨æµ‹è¯•å­˜å‚¨åŠŸèƒ½...\n';
            
            try {
                // æµ‹è¯•åŒæ­¥å­˜å‚¨
                const testData = { test: 'value', timestamp: Date.now() };
                await chrome.storage.sync.set(testData);
                output.textContent += 'âœ… åŒæ­¥å­˜å‚¨å†™å…¥æˆåŠŸ\n';
                
                const result = await chrome.storage.sync.get('test');
                if (result.test === 'value') {
                    output.textContent += 'âœ… åŒæ­¥å­˜å‚¨è¯»å–æˆåŠŸ\n';
                } else {
                    output.textContent += 'âŒ åŒæ­¥å­˜å‚¨è¯»å–å¤±è´¥\n';
                }
                
                // æµ‹è¯•æœ¬åœ°å­˜å‚¨
                await chrome.storage.local.set({ localTest: 'localValue' });
                output.textContent += 'âœ… æœ¬åœ°å­˜å‚¨å†™å…¥æˆåŠŸ\n';
                
                const localResult = await chrome.storage.local.get('localTest');
                if (localResult.localTest === 'localValue') {
                    output.textContent += 'âœ… æœ¬åœ°å­˜å‚¨è¯»å–æˆåŠŸ\n';
                } else {
                    output.textContent += 'âŒ æœ¬åœ°å­˜å‚¨è¯»å–å¤±è´¥\n';
                }
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                await chrome.storage.sync.remove('test');
                await chrome.storage.local.remove('localTest');
                output.textContent += 'âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ\n';
                
            } catch (error) {
                output.textContent += `âŒ å­˜å‚¨æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}\n`;
            }
        }

        // æµ‹è¯•æ¶ˆæ¯ä¼ é€’
        async function testMessaging() {
            const output = document.getElementById('extensionStatus');
            output.textContent = 'æ­£åœ¨æµ‹è¯•æ¶ˆæ¯ä¼ é€’...\n';
            
            try {
                // æµ‹è¯•å‘é€æ¶ˆæ¯åˆ°background script
                const response = await chrome.runtime.sendMessage({
                    type: 'GET_SETTINGS'
                });
                
                if (response && response.autoDownload !== undefined) {
                    output.textContent += 'âœ… æ¶ˆæ¯ä¼ é€’åˆ°background scriptæˆåŠŸ\n';
                    output.textContent += `   è®¾ç½®æ•°æ®: ${JSON.stringify(response, null, 2)}\n`;
                } else {
                    output.textContent += 'âŒ æ¶ˆæ¯ä¼ é€’åˆ°background scriptå¤±è´¥\n';
                }
                
            } catch (error) {
                output.textContent += `âŒ æ¶ˆæ¯ä¼ é€’æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}\n`;
            }
        }

        // æµ‹è¯•å¤åˆ¶é™åˆ¶è§£é™¤
        function testCopyRestrictions() {
            const output = document.getElementById('functionTest');
            output.textContent = 'æ­£åœ¨æµ‹è¯•å¤åˆ¶é™åˆ¶è§£é™¤åŠŸèƒ½...\n';
            
            // æ£€æŸ¥æ ·å¼æ³¨å…¥
            const copyFixStyle = document.getElementById('cnki-helper-copy-fix');
            if (copyFixStyle) {
                output.textContent += 'âœ… å¤åˆ¶é™åˆ¶è§£é™¤æ ·å¼å·²æ³¨å…¥\n';
                
                // æ£€æŸ¥æ ·å¼å†…å®¹
                const styleContent = copyFixStyle.textContent;
                if (styleContent.includes('user-select: auto !important')) {
                    output.textContent += 'âœ… æ ·å¼å†…å®¹æ­£ç¡®\n';
                } else {
                    output.textContent += 'âŒ æ ·å¼å†…å®¹ä¸æ­£ç¡®\n';
                }
            } else {
                output.textContent += 'âŒ å¤åˆ¶é™åˆ¶è§£é™¤æ ·å¼æœªæ³¨å…¥\n';
            }
            
            // æµ‹è¯•æ–‡æœ¬é€‰æ‹©
            const testText = document.createElement('div');
            testText.textContent = 'è¿™æ˜¯æµ‹è¯•æ–‡æœ¬ï¼Œåº”è¯¥å¯ä»¥é€‰æ‹©';
            testText.style.cssText = 'user-select: none; padding: 10px; border: 1px solid #ccc;';
            document.body.appendChild(testText);
            
            const selection = window.getSelection();
            selection.selectAllChildren(testText);
            
            if (selection.toString().length > 0) {
                output.textContent += 'âœ… æ–‡æœ¬é€‰æ‹©åŠŸèƒ½æ­£å¸¸\n';
            } else {
                output.textContent += 'âŒ æ–‡æœ¬é€‰æ‹©åŠŸèƒ½å¼‚å¸¸\n';
            }
            
            // æ¸…ç†æµ‹è¯•å…ƒç´ 
            document.body.removeChild(testText);
        }

        // æµ‹è¯•UIæ³¨å…¥
        function testUIInjection() {
            const output = document.getElementById('functionTest');
            output.textContent = 'æ­£åœ¨æµ‹è¯•UIæ³¨å…¥åŠŸèƒ½...\n';
            
            // æ£€æŸ¥å·¥å…·æ 
            const toolbar = document.getElementById('cnki-helper-toolbar');
            if (toolbar) {
                output.textContent += 'âœ… å·¥å…·æ å·²æ³¨å…¥\n';
                
                // æ£€æŸ¥å·¥å…·æ å†…å®¹
                const buttons = toolbar.querySelectorAll('.toolbar-btn');
                output.textContent += `   æ‰¾åˆ° ${buttons.length} ä¸ªå·¥å…·æ æŒ‰é’®\n`;
                
                // æ£€æŸ¥å¤åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨
                const copyStatus = toolbar.querySelector('.copy-status');
                if (copyStatus) {
                    output.textContent += 'âœ… å¤åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨å·²æ˜¾ç¤º\n';
                } else {
                    output.textContent += 'âŒ å¤åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨æœªæ˜¾ç¤º\n';
                }
            } else {
                output.textContent += 'âŒ å·¥å…·æ æœªæ³¨å…¥\n';
            }
            
            // æ£€æŸ¥æ¶ˆæ¯å®¹å™¨
            const messageContainer = document.getElementById('cnki-message-container');
            if (messageContainer) {
                output.textContent += 'âœ… æ¶ˆæ¯å®¹å™¨å·²æ³¨å…¥\n';
            } else {
                output.textContent += 'âŒ æ¶ˆæ¯å®¹å™¨æœªæ³¨å…¥\n';
            }
        }

        // æµ‹è¯•è®¾ç½®åŠŸèƒ½
        async function testSettings() {
            const output = document.getElementById('functionTest');
            output.textContent = 'æ­£åœ¨æµ‹è¯•è®¾ç½®åŠŸèƒ½...\n';
            
            try {
                // æµ‹è¯•è®¾ç½®è¯»å–
                const settings = await chrome.storage.sync.get({
                    autoDownload: false,
                    enhanceSearch: true,
                    quickAccess: true
                });
                
                output.textContent += 'âœ… è®¾ç½®è¯»å–æˆåŠŸ\n';
                output.textContent += `   å½“å‰è®¾ç½®: ${JSON.stringify(settings, null, 2)}\n`;
                
                // æµ‹è¯•è®¾ç½®æ›´æ–°
                const newSettings = { testSetting: 'testValue' };
                await chrome.storage.sync.set(newSettings);
                output.textContent += 'âœ… è®¾ç½®æ›´æ–°æˆåŠŸ\n';
                
                // éªŒè¯è®¾ç½®æ›´æ–°
                const updatedSettings = await chrome.storage.sync.get('testSetting');
                if (updatedSettings.testSetting === 'testValue') {
                    output.textContent += 'âœ… è®¾ç½®æ›´æ–°éªŒè¯æˆåŠŸ\n';
                } else {
                    output.textContent += 'âŒ è®¾ç½®æ›´æ–°éªŒè¯å¤±è´¥\n';
                }
                
                // æ¸…ç†æµ‹è¯•è®¾ç½®
                await chrome.storage.sync.remove('testSetting');
                output.textContent += 'âœ… æµ‹è¯•è®¾ç½®æ¸…ç†å®Œæˆ\n';
                
            } catch (error) {
                output.textContent += `âŒ è®¾ç½®æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}\n`;
            }
        }

        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        function showSystemInfo() {
            const output = document.getElementById('systemInfo');
            output.textContent = 'ç³»ç»Ÿä¿¡æ¯:\n';
            output.textContent += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}\n`;
            output.textContent += `å¹³å°: ${navigator.platform}\n`;
            output.textContent += `è¯­è¨€: ${navigator.language}\n`;
            output.textContent += `Cookieå¯ç”¨: ${navigator.cookieEnabled}\n`;
            output.textContent += `åœ¨çº¿çŠ¶æ€: ${navigator.onLine}\n`;
            output.textContent += `å½“å‰URL: ${window.location.href}\n`;
            output.textContent += `é¡µé¢æ ‡é¢˜: ${document.title}\n`;
            output.textContent += `é¡µé¢åŠ è½½æ—¶é—´: ${new Date().toLocaleString()}\n`;
        }

        // æ˜¾ç¤ºæ§åˆ¶å°æ—¥å¿—
        function showConsoleLogs() {
            const output = document.getElementById('systemInfo');
            output.textContent = 'æ§åˆ¶å°æ—¥å¿—:\n';
            output.textContent += 'æ³¨æ„: è¿™é‡Œåªèƒ½æ˜¾ç¤ºé¡µé¢åŠ è½½åçš„æ—¥å¿—\n';
            output.textContent += 'è¯·æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°è·å–å®Œæ•´æ—¥å¿—\n';
        }

        // è¯Šæ–­é”™è¯¯
        function diagnoseErrors() {
            const output = document.getElementById('errorDiagnosis');
            output.textContent = 'å¼€å§‹é”™è¯¯è¯Šæ–­...\n';
            
            // æ£€æŸ¥å¸¸è§é”™è¯¯
            let errorCount = 0;
            
            // æ£€æŸ¥æ‰©å±•API
            if (typeof chrome === 'undefined') {
                output.textContent += 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨\n';
                errorCount++;
            }
            
            // æ£€æŸ¥è¿è¡Œæ—¶
            if (!chrome.runtime) {
                output.textContent += 'âŒ Chromeè¿è¡Œæ—¶ä¸å¯ç”¨\n';
                errorCount++;
            }
            
            // æ£€æŸ¥å­˜å‚¨
            if (!chrome.storage) {
                output.textContent += 'âŒ Chromeå­˜å‚¨APIä¸å¯ç”¨\n';
                errorCount++;
            }
            
            // æ£€æŸ¥æ ‡ç­¾é¡µ
            if (!chrome.tabs) {
                output.textContent += 'âŒ Chromeæ ‡ç­¾é¡µAPIä¸å¯ç”¨\n';
                errorCount++;
            }
            
            // æ£€æŸ¥è„šæœ¬æ³¨å…¥
            if (!chrome.scripting) {
                output.textContent += 'âŒ Chromeè„šæœ¬æ³¨å…¥APIä¸å¯ç”¨\n';
                errorCount++;
            }
            
            if (errorCount === 0) {
                output.textContent += 'âœ… æ‰€æœ‰åŸºæœ¬APIæ£€æŸ¥é€šè¿‡\n';
            } else {
                output.textContent += `âŒ å‘ç° ${errorCount} ä¸ªAPIé—®é¢˜\n`;
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('extensionStatus').textContent = '';
            document.getElementById('functionTest').textContent = '';
            document.getElementById('systemInfo').textContent = '';
            document.getElementById('errorDiagnosis').textContent = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æ‰©å±•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkExtensionStatus, 1000);
        });
    </script>
</body>
</html>
